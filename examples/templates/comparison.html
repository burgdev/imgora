<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Backend Comparison</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css">
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="prism-theme-dark" media="(prefers-color-scheme: dark)" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" id="prism-theme-light" media="(prefers-color-scheme: light)" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        :root {
            --card-bg: var(--card-background);
            --card-border: var(--card-border-color);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --card-hover: rgba(0, 0, 0, 0.03);
        }

        [data-theme="dark"] {
            --card-bg: var(--card-background);
            --card-border: var(--card-border-color);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --card-hover: rgba(255, 255, 255, 0.03);
        }

        body {
            padding: 2rem 1rem;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
        }


        .card h3, .card h4 {
            margin: 0 0 0.5rem 0;
        }

        .card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 1px solid var(--card-border);
        }

        .card img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, var(--grid-min-item-size, 20rem)), 1fr));
            gap: var(--grid-gap, 1.5rem);
            margin: 2rem 0;
        }

        .text-center {
            text-align: center;
        }

        .theme-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .code-block {
            position: relative;
            margin: 1rem 0;
            border-radius: 4px;
            overflow: hidden;
        }

        .code-header {
            background: #f5f5f5;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            font-family: monospace;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        [data-theme="dark"] .code-header {
            background: #2a2a2a;
            border-bottom-color: #3a3a3a;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.8rem;
        }

        [data-theme="dark"] .copy-btn {
            color: #aaa;
        }

        .copy-btn:hover {
            color: var(--primary);
        }

        .meta-pre {
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
            border-radius: 0 0 4px 4px;
        }

        .command-caption {
            font-family: monospace;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            border-left: 3px solid var(--primary);
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .theme-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="container" style="margin-bottom: 2rem; max-width: 1400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h2 style="margin: 0; font-size: 1.25rem;">Image Comparison</h2>
                <small>Generated on {{ timestamp }}</small>
            <button id="themeToggle" class="outline secondary" onclick="toggleTheme()" style="max-width: 6rem; margin: 0; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                <span id="themeIcon">🌓</span> Toggle
            </button>
            </div>
        </div>

        {% if source_url %}
        <section class="card">
            <header>
                <h4>Source Image</h4>
            </header>
            <div class="text-left">
                <a href="{{ source_url }}" target="_blank" style="display: block;">
                    <img src="{{ source_url }}" alt="Source Image" style="max-width: 100%; border-radius: 4px; cursor: pointer; max-height: 300px;">
                </a>
            </div>
            <p style="margin: 0; word-break: break-all;">
                <a href="{{ source_url }}" target="_blank" class="secondary" style="font-size: 0.9rem;">{{ source_url }}</a>
            </p>
        </section>
        {% endif %}

        {% for transform in transformations %}
        <section class="card">
            <header>
                <h2>{{ transform.name }}</h2>
                {% if transform.description %}
                <p style="margin: 0.5rem 0 0 0;">{{ transform.description }}</p>
                {% endif %}
            </header>
            <div class="command-caption">
                <strong>Command:</strong>
                <code>image = Image(image=source_url){{ transform.steps|e }}</code>
            </div>

            <div class="grid">
                {% for backend_name, result in transform.results.items() %}
                <div>
                    <div class="card">
                        <header>
                            <h5>{{ backend_name }}</h5>
                        </header>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div style="flex: 1; display: flex; align-items: top; justify-content: center; padding: 1rem 0;">
                                {% if result.success %}
                                <img src="{{ result.url }}" alt="{{ transform.name }} - {{ backend_name }}"
                                     style="max-height: 200px; max-width: 100%; height: auto;"
                                     onclick="openModal('{{ result.url }}')">
                                {% else %}
                                <div role="alert" class="secondary">
                                    <strong>Error:</strong> {{ result.error }}
                                </div>
                                {% endif %}
                            </div>
                            <div style="margin-top: auto;">
                                {% if result.meta %}
                                <details>
                                    <summary>Metadata</summary>
                                    <div style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem; font-size: 0.8rem;">
                                        <pre style="margin: 0;"><code class="language-json">{{ result.meta|tojson(indent=2) }}</code></pre>
                                    </div>
                                </details>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </main>

    <!-- Image Modal -->
    <dialog id="imageModal" style="border: none; border-radius: 8px; padding: 0; max-width: 90vw; max-height: 90vh; background: transparent; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
        <div style="position: relative; background: var(--card-bg); border-radius: 8px; overflow: hidden;">
            <button onclick="document.getElementById('imageModal').close()"
                    style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                ×
            </button>
            <div style="max-height: 80vh; overflow: auto; padding: 1rem;">
                <img id="modalImage" src="" alt="Preview" style="max-width: 100%; max-height: 100%; display: block; margin: 0 auto;">
            </div>
            <footer style="display: flex; justify-content: space-between; padding: 1rem; background: var(--card-hover);">
                <a href="#" id="modalImageLink" target="_blank" role="button" class="secondary outline" style="text-decoration: none;">
                    Open in New Tab
                </a>
                <!--<button onclick="document.getElementById('imageModal').close()" class="secondary">
                    Close
                </button>-->
            </footer>
        </div>
    </dialog>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script>
        // Initialize syntax highlighting
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeIcon.textContent = newTheme === 'dark' ? '🌙' : '☀️';

            // Toggle Prism.js theme
            const darkTheme = document.getElementById('prism-theme-dark');
            const lightTheme = document.getElementById('prism-theme-light');

            if (newTheme === 'dark') {
                darkTheme.media = 'all';
                lightTheme.media = 'not all';
            } else {
                darkTheme.media = 'not all';
                lightTheme.media = 'all';
            }

            // Re-run Prism highlighting
            if (window.Prism) {
                Prism.highlightAll();
            }
        }

        // Set initial theme icon
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = currentTheme === 'dark' ? '🌙' : '☀️';
        });

        // Apply saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Set initial Prism.js theme
        const darkTheme = document.getElementById('prism-theme-dark');
        const lightTheme = document.getElementById('prism-theme-light');

        if (savedTheme === 'dark') {
            darkTheme.media = 'all';
            lightTheme.media = 'not all';
        } else {
            darkTheme.media = 'not all';
            lightTheme.media = 'all';
        }

        // Initialize Prism
        if (window.Prism) {
            Prism.highlightAll();
        }

        // Copy to clipboard
        function copyToClipboard(element) {
            const text = element.textContent || element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const button = element.previousElementSibling;
                const originalText = button.innerHTML;
                button.innerHTML = '✅ Copied';
                button.style.color = 'var(--success)';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.color = '';
                }, 2000);
            });
        }

        // Open modal with image
        function openModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalImageLink = document.getElementById('modalImageLink');

            if (modal && modalImage && modalImageLink) {
                modalImage.src = imageUrl;
                modalImage.alt = 'Full size image';
                modalImageLink.href = imageUrl;
                modal.showModal();

                // Close modal when clicking outside the image
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        modal.close();
                    }
                };

                // Close with Escape key
                document.addEventListener('keydown', function closeOnEscape(event) {
                    if (event.key === 'Escape') {
                        modal.close();
                        document.removeEventListener('keydown', closeOnEscape);
                    }
                });
            }
        }
    </script>
</body>
</html>
